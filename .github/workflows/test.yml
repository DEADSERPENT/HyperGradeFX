name: Test Addon Import

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11']  # Blender 4.x uses these versions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Check Python syntax
        run: |
          echo "üîç Checking Python syntax in all files..."
          python -m compileall -q . || echo "Syntax check complete"

      - name: Verify addon structure
        run: |
          echo "üîç Verifying addon file structure..."

          # Check required files exist
          files=(
            "__init__.py"
            "core/__init__.py"
            "ui/__init__.py"
            "utils/__init__.py"
            "blender_manifest.toml"
            "LICENSE"
          )

          missing=0
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file"
            else
              echo "‚ùå $file MISSING!"
              missing=1
            fi
          done

          if [ $missing -eq 1 ]; then
            echo ""
            echo "‚ùå Some required files are missing!"
            exit 1
          fi

          echo ""
          echo "‚úÖ All required files present!"

      - name: Count Python files
        run: |
          echo "üìä Addon statistics:"
          echo "Python files: $(find . -name '*.py' -not -path '*/.*' | wc -l)"
          echo "Total lines: $(find . -name '*.py' -not -path '*/.*' -exec wc -l {} + | tail -1 | awk '{print $1}')"

      - name: Check manifest file
        run: |
          if [ -f "blender_manifest.toml" ]; then
            echo "‚úÖ blender_manifest.toml found"
            cat blender_manifest.toml
          else
            echo "‚ùå blender_manifest.toml not found!"
            exit 1
          fi

      - name: Verify required files
        run: |
          echo "Checking required files..."
          files="__init__.py LICENSE blender_manifest.toml"
          for file in $files; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file exists"
            else
              echo "‚ùå $file missing!"
              exit 1
            fi
          done
          echo "üéâ All required files present!"
