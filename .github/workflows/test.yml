name: Test Addon Import

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11']  # Blender 4.x uses these versions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install fake-bpy-module (for testing without Blender)
        run: |
          pip install fake-bpy-module-4.2

      - name: Test addon syntax and structure
        run: |
          echo "Testing HyperGradeFX addon structure..."
          python -c "
          import sys
          import os
          import py_compile

          # Test: Compile all Python files to check syntax
          print('üîç Checking Python syntax...')
          errors = []

          for root, dirs, files in os.walk('.'):
              # Skip hidden and build directories
              dirs[:] = [d for d in dirs if not d.startswith('.') and d != 'build']

              for file in files:
                  if file.endswith('.py'):
                      filepath = os.path.join(root, file)
                      try:
                          py_compile.compile(filepath, doraise=True)
                          print(f'  ‚úÖ {filepath}')
                      except py_compile.PyCompileError as e:
                          print(f'  ‚ùå {filepath}: {e}')
                          errors.append(filepath)

          if errors:
              print(f'\\n‚ùå Syntax errors found in {len(errors)} files')
              sys.exit(1)
          else:
              print('\\n‚úÖ All Python files have valid syntax!')
          "

      - name: Test addon imports (with fake bpy)
        run: |
          echo "Testing if modules can be imported..."
          python -c "
          import sys
          import os

          # Add addon to path
          sys.path.insert(0, os.getcwd())

          # Mock bpy if not available
          try:
              import bpy
          except ImportError:
              print('‚ÑπÔ∏è  Using fake-bpy-module for testing')

          # Test importing utility modules (don't depend on bpy heavily)
          try:
              from utils import constants
              print('‚úÖ utils.constants imported')
          except Exception as e:
              print(f'‚ö†Ô∏è  Could not import utils.constants: {e}')

          try:
              from utils import security
              print('‚úÖ utils.security imported')
          except Exception as e:
              print(f'‚ö†Ô∏è  Could not import utils.security: {e}')

          # Test that files exist and have correct structure
          print('\\nüîç Checking module structure...')
          required_files = [
              '__init__.py',
              'core/__init__.py',
              'ui/__init__.py',
              'utils/__init__.py',
              'blender_manifest.toml',
              'LICENSE'
          ]

          missing = []
          for file in required_files:
              if os.path.exists(file):
                  print(f'  ‚úÖ {file}')
              else:
                  print(f'  ‚ùå {file} MISSING!')
                  missing.append(file)

          if missing:
              print(f'\\n‚ùå Missing required files!')
              sys.exit(1)

          print('\\n‚úÖ Addon structure is valid!')
          print('‚ÑπÔ∏è  Note: Full import testing requires Blender runtime')
          "

      - name: Check manifest file
        run: |
          if [ -f "blender_manifest.toml" ]; then
            echo "‚úÖ blender_manifest.toml found"
            cat blender_manifest.toml
          else
            echo "‚ùå blender_manifest.toml not found!"
            exit 1
          fi

      - name: Verify required files
        run: |
          echo "Checking required files..."
          files="__init__.py LICENSE blender_manifest.toml"
          for file in $files; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file exists"
            else
              echo "‚ùå $file missing!"
              exit 1
            fi
          done
          echo "üéâ All required files present!"
